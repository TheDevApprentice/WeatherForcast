@model IEnumerable<domain.Entities.ApiKey>
@{
    ViewData["Title"] = "Mes Cl√©s API";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="bi bi-key-fill"></i> Mes Cl√©s API
                </h2>
                <a asp-action="Create" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> G√©n√©rer une Nouvelle Cl√©
                </a>
            </div>

            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="bi bi-check-circle-fill"></i> @TempData["SuccessMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i> @TempData["ErrorMessage"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            }

            @if (TempData["NewApiKey"] != null && TempData["NewApiSecret"] != null)
            {
                <div class="alert alert-warning" role="alert">
                    <h5><i class="bi bi-exclamation-triangle-fill"></i> Nouvelle Cl√© API Cr√©√©e</h5>
                    <p><strong>‚ö†Ô∏è Copiez ces informations MAINTENANT ! Elles ne seront plus affich√©es.</strong></p>
                    
                    <div class="mb-3">
                        <label class="form-label"><strong>Client ID (Cl√©) :</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="@TempData["NewApiKey"]" id="apiKey" readonly>
                            <button class="btn btn-outline-secondary btn-copy" type="button" data-target="apiKey">
                                <i class="bi bi-clipboard"></i> Copier
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Client Secret (Secret) :</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" value="@TempData["NewApiSecret"]" id="apiSecret" readonly>
                            <button class="btn btn-outline-secondary btn-copy" type="button" data-target="apiSecret">
                                <i class="bi bi-clipboard"></i> Copier
                            </button>
                        </div>
                    </div>

                    <hr>
                    <p class="mb-0"><strong>Utilisation :</strong></p>
                    <pre class="bg-dark text-light p-3 rounded"><code>curl -u "@TempData["NewApiKey"]:@TempData["NewApiSecret"]" \
     https://api.weatherforecast.com/api/weatherforecast</code></pre>
                </div>
            }

            @if (Model == null || !Model.Any())
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i> Vous n'avez pas encore de cl√© API. 
                    <a asp-action="Create" class="alert-link">Cr√©ez-en une maintenant</a> pour utiliser l'API REST.
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Cl√© (Client ID)</th>
                                    <th>Cr√©√©e le</th>
                                    <th>Derni√®re utilisation</th>
                                    <th>Requ√™tes</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var key in Model)
                                {
                                    <tr>
                                        <td>
                                            <strong>@key.Name</strong>
                                            @if (!string.IsNullOrEmpty(key.AllowedIpAddress))
                                            {
                                                <br><small class="text-muted">IP restreinte: @key.AllowedIpAddress</small>
                                            }
                                        </td>
                                        <td><code>@key.Key</code></td>
                                        <td>@key.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>
                                            @if (key.LastUsedAt.HasValue)
                                            {
                                                @key.LastUsedAt.Value.ToString("dd/MM/yyyy HH:mm")
                                            }
                                            else
                                            {
                                                <span class="text-muted">Jamais</span>
                                            }
                                        </td>
                                        <td>@key.RequestCount.ToString("N0")</td>
                                        <td>
                                            @if (!key.IsActive)
                                            {
                                                <span class="badge bg-danger">R√©voqu√©e</span>
                                            }
                                            else if (key.ExpiresAt.HasValue && key.ExpiresAt.Value < DateTime.UtcNow)
                                            {
                                                <span class="badge bg-warning">Expir√©e</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">Active</span>
                                            }
                                        </td>
                                        <td>
                                            @if (key.IsActive)
                                            {
                                                <form asp-action="Revoke" asp-route-id="@key.Id" method="post" class="d-inline revoke-form">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        <i class="bi bi-trash"></i> R√©voquer
                                                    </button>
                                                </form>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3">
                    <h5>üìö Documentation API</h5>
                    <p>Utilisez vos cl√©s API pour acc√©der √† l'API REST :</p>
                    <ul>
                        <li><strong>Endpoint de base :</strong> <code>https://localhost:7252/</code></li>
                        <li><strong>Authentification :</strong> Basic Auth (Client ID + Client Secret)</li>
                        <li><strong>Format :</strong> JSON</li>
                        <li><strong>Documentation :</strong> <a href="https://localhost:7252/swagger/index.html" target="_blank">Swagger UI</a></li>
                    </ul>
                </div>
            }
        </div>
    </div>
</div>

<script nonce="@(Context?.Items["CspNonce"] as string)">
    (function(){
        // Confirmation de r√©vocation
        document.querySelectorAll('form.revoke-form').forEach(function(f){
            f.addEventListener('submit', async function(e){
                e.preventDefault();
                const ok = window.confirmNotification
                    ? await window.confirmNotification('R√©voquer la cl√© API ?', 'Cette action est irr√©versible.', 'R√©voquer', 'Annuler')
                    : window.confirm('√ätes-vous s√ªr de vouloir r√©voquer cette cl√© API ?');
                if (ok) {
                    f.submit();
                }
            });
        });

        // Copie presse-papiers pour les champs affich√©s dans la banni√®re
        function copyValueById(elementId){
            const element = document.getElementById(elementId);
            if(!element) return;
            element.select();
            element.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(element.value).then(function(){
                if (window.showNotification) {
                    window.showNotification('Copi√© dans le presse-papiers !', 'success');
                }
            });
        }

        document.querySelectorAll('.btn-copy[data-target]').forEach(function(btn){
            btn.addEventListener('click', function(){
                const targetId = this.getAttribute('data-target');
                copyValueById(targetId);
            });
        });
    })();
</script>
