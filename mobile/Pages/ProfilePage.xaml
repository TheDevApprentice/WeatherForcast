<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="mobile.Pages.ProfilePage"
             xmlns:viewmodels="clr-namespace:mobile.PageModels"
             x:DataType="viewmodels:ProfilePageModel"
             BackgroundColor="{DynamicResource PageBackgroundColor}"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="*,Auto">
        <ScrollView x:Name="RootScroll" Scrolled="OnScrollViewScrolled" Grid.Row="0">
        <VerticalStackLayout x:Name="RootStack" Spacing="0">
            
            <!-- Header avec gradient Fluent -->
            <Grid x:Name="HeaderGrid" RowDefinitions="130,Auto" Margin="0,0,0,20">
                <!-- Gradient background -->
                <Border x:Name="HeaderBackground" Grid.RowSpan="2"
                        StrokeThickness="0"
                        StrokeShape="RoundRectangle 0,0,32,32">
                    <Border.Background>
                        <!-- Gradient statique (plus d'animation) -->
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="{DynamicResource DarkBackground}" Offset="0.0" />
                            <GradientStop Color="{DynamicResource DarkBackground}" Offset="1.0" />
                        </LinearGradientBrush>
                    </Border.Background>
                </Border>
                
                <!-- Avatar et info utilisateur -->
                <VerticalStackLayout x:Name="HeaderContent" Grid.Row="1" 
                                    Spacing="10"
                                    Margin="0,-95,0,40">
                    <!-- Avatar avec ring rotatif et initiales -->
                    <Grid WidthRequest="120" HeightRequest="120" HorizontalOptions="Center" x:Name="AvatarContainer">
                        <!-- Anneau externe avec gradient qui tourne -->
                        <Border x:Name="AvatarRing"
                                WidthRequest="120"
                                HeightRequest="120"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 60">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{DynamicResource ProfileAvatarRingGradientStart}" Offset="0.0" />
                                    <GradientStop Color="{DynamicResource ProfileAvatarRingGradientEnd}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.12" Radius="18" Offset="0,6" />
                            </Border.Shadow>
                        </Border>

                        <!-- Cercle interne pour créer l'effet d'anneau -->
                        <Border x:Name="AvatarBorder"
                                WidthRequest="110"
                                HeightRequest="110"
                                StrokeThickness="0"
                                StrokeShape="RoundRectangle 55"
                                BackgroundColor="{DynamicResource CardBackgroundColor}">
                            <Border.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                    <GradientStop Color="{DynamicResource ProfileAvatarBackground}" Offset="0.0" />
                                    <GradientStop Color="{DynamicResource ProfileAvatarBackgroundEnd}" Offset="1.0" />
                                </LinearGradientBrush>
                            </Border.Background>
                            <Border.Stroke>
                                <!-- fin liseré blanc pour accent -->
                                <SolidColorBrush Color="{DynamicResource ProfileAvatarBorder}" />
                            </Border.Stroke>
                            <Border.Shadow>
                                <Shadow Brush="Black" Opacity="0.2" Radius="24" Offset="0,8" />
                            </Border.Shadow>
                            <Label x:Name="InitialsLabel" Text="{Binding Initials}"
                                   FontSize="38"
                                   FontAttributes="Bold"
                                   TextColor="White"
                                   HorizontalOptions="Center"
                                   VerticalOptions="Center"/>
                        </Border>
                    </Grid>
                    
                    <!-- Nom utilisateur -->
                    <Label x:Name="NameLabel" Text="{Binding UserName}"
                           FontSize="24"
                           FontAttributes="Bold"
                           HorizontalOptions="Center"
                           TextColor="{DynamicResource White}"/>
                    
                    <!-- Email -->
                    <Label x:Name="EmailLabel" Text="{Binding UserEmail}"
                           FontSize="14"
                           HorizontalOptions="Center"
                           Opacity="0.7"
                           TextColor="{DynamicResource White}"/>
                </VerticalStackLayout>
            </Grid>

            <!-- Menu Options -->
            <VerticalStackLayout x:Name="ContentStack" Spacing="16" Padding="10,0">
                    
                <!-- Card Apparence avec Fluent Design -->
                <Border StrokeShape="RoundRectangle 12"
                        BackgroundColor="{DynamicResource CardBackgroundColor}"
                        StrokeThickness="0"
                        Padding="0"
                        IsVisible="{Binding ShowThemeToggle}">
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.04" Radius="8" Offset="0,2" />
                    </Border.Shadow>

                    <Grid Padding="10,16" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                        <!-- Texte -->
                        <VerticalStackLayout Grid.Column="1" 
                                           Spacing="2"
                                           VerticalOptions="Center">
                            <Label Text="Thème sombre"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource PrimaryTextColor}"/>
                            <Label Text="Activer le mode sombre"
                                   FontSize="13"
                                   Opacity="0.6"
                                   TextColor="{DynamicResource SecondaryTextColor}"/>
                        </VerticalStackLayout>
                        
                        <!-- Switch -->
                        <Switch Grid.Column="2"
                                x:Name="ThemeSwitch"
                                HorizontalOptions="Center"
                                VerticalOptions="Center"
                                OnColor="{DynamicResource ProfileAvatarRingGradientStart}"
                                ThumbColor="{DynamicResource LightSecondaryBackground}"
                                Toggled="ThemeSwitch_Toggled"/>
                    </Grid>
                </Border>

                <!-- Card Paramètres avec Fluent Design -->
                <Border x:Name="SettingsCard"
                        StrokeShape="RoundRectangle 12"
                        BackgroundColor="{DynamicResource CardBackgroundColor}"
                        StrokeThickness="0"
                        Padding="0">
                    <Border.GestureRecognizers>
                        <TapGestureRecognizer Command="{Binding OpenSettingsCommand}" Tapped="OnSettingsCardTapped" />
                    </Border.GestureRecognizers>
                    <Border.Shadow>
                        <Shadow Brush="Black" Opacity="0.04" Radius="8" Offset="0,2" />
                    </Border.Shadow>
                    
                    <Grid Padding="10,16" ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
                     
                        <!-- Texte -->
                        <VerticalStackLayout Grid.Column="1" 
                                           Spacing="2"
                                           VerticalOptions="Center">
                            <Label Text="Paramètres"
                                   FontSize="16"
                                   FontAttributes="Bold"
                                   TextColor="{DynamicResource PrimaryTextColor}"/>
                            <Label Text="Gérer vos préférences"
                                   FontSize="13"
                                   Opacity="0.6"
                                   TextColor="{DynamicResource SecondaryTextColor}"/>
                        </VerticalStackLayout>
                        
                        <!-- Chevron -->
                        <Label Grid.Column="2"
                               Text="›"
                               FontSize="24"
                               Padding="0,0,10,0"
                               VerticalOptions="Center"
                               Opacity="0.3"
                               TextColor="{DynamicResource SecondaryTextColor}"/>
                    </Grid>
                </Border>
                
            </VerticalStackLayout>
        </VerticalStackLayout>
        </ScrollView>

        <!-- Bouton Déconnexion fixé en bas (visible uniquement sur mobile) -->
        <Button x:Name="LogoutButton"
                Grid.Row="1"
                Text="Déconnexion"
                Command="{Binding LogoutCommand}"
                Pressed="OnButtonPressed"
                Released="OnButtonReleased"
                BackgroundColor="#E53935"
                TextColor="White"
                FontSize="16"
                FontAttributes="Bold"
                CornerRadius="12"
                HeightRequest="56"
                Margin="20,10,20,20"
                IsVisible="{Binding ShowLogoutButton}"
                IsEnabled="{Binding CanLogout}"
                Opacity="{Binding CanLogout, Converter={StaticResource BoolToOpacityConverter}}">
            <Button.Shadow>
                <Shadow Brush="#E53935" Opacity="0.04" Radius="8" Offset="0,2" />
            </Button.Shadow>
        </Button>
    </Grid>

</ContentPage>
