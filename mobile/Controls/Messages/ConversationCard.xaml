<?xml version="1.0" encoding="utf-8" ?>
<Border xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
        xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
        xmlns:models="clr-namespace:mobile.Models"
        x:Class="mobile.Controls.ConversationCard"
        x:DataType="models:Conversation"
        BackgroundColor="{DynamicResource CardBackgroundColor}"
        Padding="16,12"
        Margin="0"
        StrokeThickness="1"
        Stroke="{DynamicResource BorderColor}">
    
    <!-- Fond différent si non lu -->
    <Border.Triggers>
        <DataTrigger TargetType="Border"
                     Binding="{Binding HasUnreadMessages}"
                     Value="True">
            <Setter Property="BackgroundColor" 
                    Value="{DynamicResource SelectedItemBackground}"/>
        </DataTrigger>
    </Border.Triggers>
    
    <Border.GestureRecognizers>
        <TapGestureRecognizer Tapped="OnConversationTapped"/>
    </Border.GestureRecognizers>
    
    <Grid ColumnDefinitions="Auto,*,Auto"
          ColumnSpacing="12"
          RowDefinitions="Auto,Auto"
          RowSpacing="4">
        
        <!-- Avatar avec initiales -->
        <Border Grid.Column="0"
                Grid.RowSpan="2"
                WidthRequest="50"
                HeightRequest="50"
                Background="{DynamicResource CardBackgroundColor}"
                StrokeShape="RoundRectangle 24"
                StrokeThickness="1"
                Stroke="{DynamicResource TertiaryTextColor}"
                Padding="0"
                Margin="0"
                HorizontalOptions="Center"
                VerticalOptions="Center">
            <Label x:Name="InitialsLabel"
                   FontSize="18"
                   FontAttributes="Bold"
                   TextColor="{DynamicResource Black}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>
        </Border>
        
        <!-- Badge épinglé (si conversation support ou épinglée) -->
        <!--<Border Grid.Column="0"
                WidthRequest="18"
                HeightRequest="18"
                Background="Transparent"
                StrokeShape="RoundRectangle 9"
                StrokeThickness="2"
                Stroke="{DynamicResource AccentColor}"
                HorizontalOptions="End"
                VerticalOptions="Start"
                Margin="0,-4,-4,0"
                IsVisible="{Binding IsPinned}">-->
        <ImageButton Grid.Column="1"
                                 HeightRequest="10"
                                 WidthRequest="10"
                                 Margin="0,-15,-10,0"
                                 BorderColor="Transparent"
                                 BorderWidth="1.5"
                                 CornerRadius="20"
                           HorizontalOptions="End"
                           VerticalOptions="Center"
                                 IsVisible="{Binding IsPinned}"
                                 Background="Transparent">
                <ImageButton.Source>
                    <FontImageSource Size="13"
                                             Glyph="&#xE840;"
                                             FontFamily="SegoeMDL2"
                                             Color="{DynamicResource PrimaryTextColor}" />
                </ImageButton.Source>
            </ImageButton>
        <!--</Border>-->
        
        <!-- Nom de la conversation -->
        <Label Grid.Column="1"
               Grid.Row="0"
               x:Name="DisplayNameLabel"
               FontSize="15"
               FontAttributes="Bold"
               TextColor="{DynamicResource PrimaryTextColor}"
               LineBreakMode="TailTruncation"
               MaxLines="1"/>
        
        <!-- Dernier message -->
        <Label Grid.Column="1"
               Grid.Row="1"
               x:Name="LastMessageLabel"
               FontSize="13"
               TextColor="{DynamicResource SecondaryTextColor}"
               LineBreakMode="TailTruncation"
               MaxLines="1"/>
        
        <!-- Timestamp -->
        <Label Grid.Column="2"
               Grid.Row="0"
               x:Name="TimestampLabel"
               FontSize="11"
               TextColor="{DynamicResource SecondaryTextColor}"
               Opacity="0.7"
               HorizontalOptions="End"
               VerticalOptions="Start"/>
        
        <!-- Badge "Non lu" avec compteur -->
        <Border Grid.Column="2"
                Grid.Row="1"
                MinimumWidthRequest="20"
                HeightRequest="20"
                Padding="6,2"
                Background="{DynamicResource Primary}"
                StrokeShape="RoundRectangle 10"
                StrokeThickness="0"
                HorizontalOptions="End"
                VerticalOptions="Center"
                IsVisible="{Binding HasUnreadMessages}">
            <Label x:Name="UnreadCountLabel"
                   FontSize="11"
                   FontAttributes="Bold"
                   TextColor="{DynamicResource White}"
                   HorizontalOptions="Center"
                   VerticalOptions="Center"/>
        </Border>
    </Grid>
</Border>
